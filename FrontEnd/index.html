<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title data-lang="title">wookingwoo - short URL</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css"
    />

    <style>
      .form {
        text-align: center;
        width: 400px;
        height: 500;
        padding-top: 120px;
        margin-left: auto;
        margin-right: auto;
      }

      .title {
        font-size: 50px;
        text-align: center;
        margin-top: 30px;
      }

      .form {
        margin-left: auto;
        margin-right: auto;
        height: auto;
        width: auto;
      }

      .result {
        align-items: center;
      }

      .copy-button {
        float: right;
      }
    </style>
  </head>

  <body>
    <section class="section">
      <h1 class="title" data-lang="title">[title]</h1>
    </section>

    <div class="container">
      <div id="form" class="field has-addons">
        <input
          style="height: 60px"
          class="input"
          type="text"
          placeholder="Enter your long URL. (ex: https://wookingwoo.com)"
        />
        <button
          style="width: 15%; height: 60px"
          id="generate-button"
          class="button is-primary"
          data-lang="create"
        >
          [create]
        </button>
      </div>

      <div hidden id="success-card" class="notification is-link is-light">
        <span style="float: left" id="result"></span>
        <button id="copy-button" class="button is-link" data-lang="copy">
          [copy]
        </button>
      </div>
    </div>

    <div hidden id="fail-card" class="notification is-warning is-light">
      <span data-lang="wrong_url_format">[wrong_url_format]</span>
    </div>

    <p id="language">
      <span data-lang="now_sys_lang">[now-sys-lang]</span> :
      <span id="locale"></span>
    </p>
    <button id="btn-en">English</button> <button id="btn-ko">Korean</button>
  </body>

  <script>
    let origin_endpoint = "https://wkw.one/wkw-short-url-generator";

    document.getElementById("generate-button").addEventListener("click", () => {
      let native_url = document.getElementsByClassName("input")[0].value;

      if (isNotValidURL(native_url)) {
        document.getElementById("success-card").style.display = "none";
        document.getElementById("fail-card").style.display = "block";
        return;
      }

      fetch(origin_endpoint, {
        method: "POST",
        headers: {
          "Access-Control-Allow-Origin": "*",
          origin: origin_endpoint,
          "x-api-key": "nS3iFxkIk27ZxRTCnxOLu1oxr1zI639ZW78zYgR9",
        },
        body: JSON.stringify({ native_url: native_url }),
      })
        .then((response) => {
          return response.json();
        })
        .then((data) => {
          if (data.short_id == null) {
          } else {
            document.getElementById("fail-card").style.display = "none";
            document.getElementById("success-card").style.display = "block";
            let shorten_url = data.forward_url + "/" + data.short_id;
            document.getElementById("result").innerHTML =
              "<a target='_blank' href='https://" +
              shorten_url +
              "'>" +
              "https://" +
              shorten_url +
              "</a>";
          }
        })
        .catch((err) => {
          console.log(err);
        });
    });

    document
      .getElementById("copy-button")
      .addEventListener("click", async () => {
        let copyText = document.getElementById("result").innerText;
        await navigator.clipboard.writeText(copyText);
      });

    function isNotValidURL(str) {
      let pattern = new RegExp(
        /(https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|www\.[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9]+\.[^\s]{2,}|www\.[a-zA-Z0-9]+\.[^\s]{2,})/gi
      );
      return !pattern.test(str);
    }
  </script>

  <script>
    // 다국어 지원 script
    // 언어별 JSON 파일
    const lang = {
      en: {
        title: "wookingwoo - short URL",
        ISO_639_1_Language_Codes: "en",
        now_sys_lang: "System locale",
        create: "create",
        copy: "copy",
        wrong_url_format: "Not a valid URL. Add https:// or http://",
      },
      ko: {
        title: "우킹우 - 단축 URL",
        ISO_639_1_Language_Codes: "ko",
        now_sys_lang: "시스템 지역",
        create: "줄이기",
        copy: "복사",
        wrong_url_format:
          "URL 형식이 올바르지 않습니다. https:// 혹은 http:// 를 붙여서 작성해주세요",
      },
    };

    // 현재 브라우저의 언어 가져오기
    function getLanguage() {
      return navigator.language || navigator.userLanguage;
    }

    // 언어별 적용
    function init(localeStr) {
      document.getElementById("locale").textContent = localeStr;
    }

    // 초기 작업
    const systemLang = getLanguage(); // systemLang = 브라우저의 언어
    let currentLang = localStorage.getItem("lang"); // localStorage에 저장된 'lang'값 가져오기 (마지막 언어 선택값)

    if (currentLang == "" || currentLang == null || currentLang == undefined) {
      currentLang = systemLang; // currentLang가 null일 경우 브라우저 언어로 사용
    }

    init(systemLang);
    render(currentLang.substr(0, 2));

    // 언어별 렌더링
    function render(locale) {
      const $lang = document.querySelectorAll("[data-lang]");
      $lang.forEach((el) => {
        const code = el.dataset.lang;

        try {
          el.textContent = lang[locale][code];
        } catch (error) {
          el.textContent = lang["en"][code];
        }
      });
    }

    // 버튼 이벤트
    document.getElementById("btn-en").addEventListener("click", (e) => {
      render("en");
      localStorage.setItem("lang", "en"); // localStorage에 선택 언어 저장
    });
    document.getElementById("btn-ko").addEventListener("click", (e) => {
      render("ko");
      localStorage.setItem("lang", "ko"); // localStorage에 선택 언어 저장
    });
  </script>
</html>
